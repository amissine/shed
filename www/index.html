<!DOCTYPE html>
<html lang='en'>
  <head> <!-- {{{1 -->
    <meta charset="utf-8"/>
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <!--
    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>
    FOR MAKERS: <i class="fas fa-user-clock"></i>
    FOR TAKERS: <i class="fas fa-user-cog"></i>
    colors: requestor, asker - red, offerer, bidder - green
    -->
    <script src='kit.fontawesome.com-a076d05399.js'></script>
    <title>GRATZIO</title>
    <link rel="stylesheet" type="text/css" href="./style.css" />
  </head>
  <body onload='initApp()' onunload='releaseApp()'> <!-- {{{1 -->
    <div id="map"></div>
    <!-- The common parent Modal {{{2 -->
    <div id="commonParentModal" class="modal">
      <!-- GRATZIO Welcome Pane {{{3 -->
      <div id='inviteOrSK' class="modal-content">
        <span id='inviteOrSKX' class="close">&times;</span>
        <form> 
          <p> <!-- {{{4 -->
          Welcome to Stellar Help Exchange!</p>
          <p>
          What would you like to do? (See our <a href='https://github.com/amissine/shed#frequently-asked-questions'>FAQ</a>
          for more info on your choices.)</p>
          <div>
          <input type='radio' name='welcome-choice' onclick='requestInvite()'>
                 Request a special invite
          </div>
          <div>
          <input type='radio' name='welcome-choice' onclick='acceptInvite()'>
                 Accept the invite
          </div>
          <div>
          <input type='radio' name='welcome-choice' onclick='storeSK()'>
                Store your Stellar Secret Key on this device
          </div>
          <div id='invite' style='display:none'>
            <b>Invite</b>
            <input type="text" size='40' placeholder='Paste here the invite from our email'>
          </div>
          <div id='greeting' style='display:none'>
            <b>Greeting</b>
            <input type="text" placeholder="E.g., Miss Alice" required>
          </div>
          <div id='emailAddress' style='display:none'>
            <b>Email</b>
            <input type="text" placeholder="Your email address" required>
          </div>
          <div id='secretKey' style='display:none'>
            <input type="text" size='60' maxlength='56' placeholder="Your Stellar account secret key" required>
          </div>
          <div id='fundsRequested' style='display:none'>
            <b>Funds requested</b>, GRAT
            <input type="text" size='3' maxlength='3' placeholder='999'>
          </div>
          <hr>
          <!-- }}}4 -->
          <p>By continuing you agree to our 
          <a href="https://www.termsfeed.com/live/47782836-acc3-4660-a75b-a44a24dc50fb" style="color:dodgerblue">Terms & Conditions</a>.
          </p>
          <button id='inviteOrSK_go' type="button" 
            disabled onclick='inviteOrSK_f()'>Continue</button>
          <div id='inviteOrSK_goCogs' style="display:none">
            XXX... <img src='favicon.ico'/>
          </div>
          <div id='onJoin' style="display:none">
            Congratulations on joining our Help Exchange, XXX!
            The Stellar Network in use is XXX.
            XXX
            You can now start your first user session with us. To do so, simply
            close (click on the &times; thing in the top-right corner of) this 
            modal window.
          </div>
        </form>
      </div>
      <!-- }}}3 -->
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/9.1.0/stellar-sdk.js"></script><!-- {{{2 -->
    <script> // {{{2
function requestInvite () { // {{{3
  process.choice = 'requestInvite'
  document.getElementById('inviteOrSK_go').disabled = false
  document.getElementById('invite').style.display = 'none'
  document.getElementById('invite').lastElementChild.value = ''
  document.getElementById('greeting').style.display = 'block'
  document.getElementById('emailAddress').style.display = 'block'
  document.getElementById('secretKey').style.display = 'none'
  document.getElementById('secretKey').lastElementChild.value = ''
  document.getElementById('fundsRequested').style.display = 'none'
  document.getElementById('fundsRequested').lastElementChild.value = ''
}

function acceptInvite () { // {{{3
  process.choice = 'acceptInvite'
  document.getElementById('inviteOrSK_go').disabled = false
  document.getElementById('invite').style.display = 'block'
  document.getElementById('greeting').style.display = 'none'
  document.getElementById('greeting').lastElementChild.value = ''
  document.getElementById('emailAddress').style.display = 'none'
  document.getElementById('emailAddress').lastElementChild.value = ''
  document.getElementById('secretKey').style.display = 'none'
  document.getElementById('secretKey').lastElementChild.value = ''
  document.getElementById('fundsRequested').style.display = 'none'
  document.getElementById('fundsRequested').lastElementChild.value = ''
}

function storeSK () { // {{{3
  process.choice = 'storeSecretKey'
  document.getElementById('inviteOrSK_go').disabled = false
  document.getElementById('invite').style.display = 'none'
  document.getElementById('invite').lastElementChild.value = ''
  document.getElementById('greeting').style.display = 'block'
  document.getElementById('emailAddress').style.display = 'block'
  document.getElementById('secretKey').style.display = 'block'
  document.getElementById('fundsRequested').style.display = 'block'
}

function inviteOrSK_f () { // {{{3
  // Collect data {{{4
  let invite = document.getElementById('invite').lastElementChild.value
  let greeting = document.getElementById('greeting').lastElementChild.value
  let emailAddress = document.getElementById('emailAddress').lastElementChild.value
  let secretKey = document.getElementById('secretKey').lastElementChild.value
  let fundsRequested = document.getElementById('fundsRequested').lastElementChild.value
  let textContent
  try {
    // Validate data {{{4
    switch (process.choice) {
      case 'acceptInvite':
        if (!ok(invite)) throw 'Bad Invite';
        textContent = 'Creating your Stellar account and funding it with GRAT 1000'
        break;
      case 'storeSecretKey':
        if (!ok(secretKey)) throw 'Bad Secret Key';
        textContent = 'Storing your info on this device'
        if (fundsRequested) {
          textContent += ', funding your account with GRAT ' + fundsRequested
        }
      case 'requestInvite':
        if (!ok(greeting)) throw 'Bad Greeting';
        if (!ok(emailAddress, true)) throw 'Bad Email';
        textContent = process.choice == 'requestInvite' ?
          'Sending you an email with your special invite' : textContent
        break;
      default:
        throw 'UNEXPECTED';
    }
    // Process data {{{4
    let cogs = document.getElementById('inviteOrSK_goCogs')
    textContent = cogs.firstChild.textContent.replace('XXX', textContent)
    cogs.firstChild.textContent = textContent
    document.getElementById('inviteOrSK_go').style.display = 'none'
    cogs.style.display = 'block'
    let detail = {
      choice: process.choice, // 'requestInvite', 'acceptInvite', 'storeSecretKey'
      invite, greeting, emailAddress, secretKey, fundsRequested
    }
    delete process.choice
    process.presenter.dispatchEvent(new CustomEvent('inviteOrSK', { detail }))
  } catch(e) {
    alert(e)
  }
  // }}}4
}

function ok (s, email = false) { // {{{3
  if (s.length == 0 || !/^[\w\s.,\-:()@]+$/.test(s)) {
    return false;
  }
  return email ? /^[\w.]+@[\w]+\.[a-z]{2,5}$/.test(s) : true;
/* See also:
  https://www.regular-expressions.info/shorthand.html
  https://regex101.com/
*/
}

let myMap // {{{3
function initMap() {
  myMap = new google.maps.Map(document.getElementById("map"), {
    center: new google.maps.LatLng(51.508742,-0.120850),
    zoom: 2,
  })
}

function initApp () { // {{{3
  process.view.init()
}

async function releaseApp () { // {{{3
  await process.presenter.release()
}
// }}}3
    </script> <!-- }}}2 -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD8M1uhXbbXIakKdUPJC_bhnwdlR38HTY4&callback=initMap&v=weekly"
    ></script>
    <script src='./presenter.js'></script>
    <script src="./index.js"></script>
  </body> <!-- }}}1 -->
</html>
